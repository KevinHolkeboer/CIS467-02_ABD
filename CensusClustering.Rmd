---
title: "Census Data Clustering ZIPs"
author: "JR Morrish"
date: "8/6/2020"
---

```{r packages, echo=FALSE, include=FALSE}
# install.packages("tinytex")
# library(tinytex)
# tinytex::install_tinytex()
library(ape)        # Hierarchical clustering
library(cluster)    # Clustering algorithms
library(clustertend)# Assess cluster tendency
library(clv)        # Evaluate stability of clustering solution
library(clValid)    # Evaluate stability of clustering solution
library(dbscan)     # Clustering algorithms
library(dendextend) # Modify graphs
library(dplyr)      # Data manipulation
library(factoextra) # Clustering algorithms & visualization
library(fpc)        # Evaluate stability of clustering solution
library(ggplot2)    # Create graphs
library(gridExtra)  # Multiple cluster plots in grid
#library(multiClust) # Data manipulation
library(mvtnorm)    # For other packages
library(mvoutlier)  # Identify multivariate outliers
library(NbClust)    # Determine number of clusters
library(outliers)   # Test for univariate outliers
library(psych)      # Descriptive statistics
library(pvclust)    # Compute cluster p-values
library(readxl)     # Read in excel files
library(Rtsne)      # Clustering mixed data
library(tidyverse)  # Data manipulation
library(openxlsx)   # Write excel files
# library(ggstatsplot)
# tinytex:::is_tinytex()
```

census <- readxl::read_xlsx("combined_data.xlsx", sheet = "Census")

census$ZIP_Pop_Density <- as.numeric(census$ZIP_Pop_Density)
census$ZIP_med_income <- as.numeric(census$ZIP_med_income)
census$ZIP_med_age <- as.numeric(census$ZIP_med_age)
census$ZIP_P_Black <- as.numeric(census$ZIP_P_Black)
census$ZIP_P_Asian <- as.numeric(census$ZIP_P_Asian)
census$ZIP_P_Hispanic <- as.numeric(census$ZIP_P_Hispanic)

census <- na.omit(census)

ef <- census

#### Transformed Data
```{r log transform data, echo=FALSE, include=FALSE}
a <- min(census$ZIP_Pop_Density[census$ZIP_Pop_Density>0])-.0001
g <- min(census$ZIP_P_Black[census$ZIP_P_Black>0])-.0001
h <- min(census$ZIP_P_Asian[census$ZIP_P_Asian>0])-.0001
i <- min(census$ZIP_P_Hispanic[census$ZIP_P_Hispanic>0])-.0001
census %>%
  mutate( 
    pd.log = log(ifelse(ZIP_Pop_Density==0,a,ZIP_Pop_Density)),
    pBl.log = log(ifelse(ZIP_P_Black==0,g,ZIP_P_Black)),
    pAn.log = log(ifelse(ZIP_P_Asian==0,h,ZIP_P_Asian)),
    pHL.log = log(ifelse(ZIP_P_Hispanic==0,i,ZIP_P_Hispanic))
  ) -> census
```

```{r normalize data, echo=FALSE, include=FALSE}
sccensus <- scale(census)
sum(is.na(sccensus))
# list rows of data that have missing values
sccensus[!complete.cases(sccensus),]
```

```{r cluster data}
sccensus <- census %>% 
  dplyr::select(2:3, 7:10) %>% 
  scale()
set.seed(4323)
sccensus %>%
  dist() %>%
  hclust() -> census.hclust
# R16 <- ef %>%
#   mutate(cluster = cutree(census.hclust,16))
# as.phylo(census.hclust) -> hcc
# plot(hcc,type="phylogram",cex=.5,label.offset=.1)
# plot(hcc,type="unrooted", cex=0.2,label.offset=.1)
fviz_dend(census.hclust, k = 16, rect = TRUE, rect_fill = TRUE, lwd = 0.5, cex = 0.5) # pop_dens, med_age, %s, med_inc
# fviz_dend(census.hclust, k = 16, rect = TRUE, rect_fill = TRUE, xlim = c(0,100), ylim = c(0,8))
# pdf("30.pdf")
``` 

```{r hierachical cuts}
# R16 <- ef %>%
#   mutate(cluster = cutree(census.hclust,3))
R16 <- ef %>%
 mutate(cluster = cutree(census.hclust,16))
# R30 <- ef %>%
#  mutate(cluster = cutree(census.hclust3,30))
```

# Get product from customer
itemkey <- "83914"

# Get customers that sell the specific product
Customer_Product <- readxl::read_xlsx("combined_data.xlsx", sheet = "Customer-Product")

soldItem <- subset(Customer_Product, ItemKey == itemkey)
soldItem <- soldItem[order(soldItem$NetRevenue),]

top10Percent = ceiling(nrow(soldItem) * 0.10)

topSellers <- head(soldItem, top10Percent)

cusList <- topSellers[['CusKey']]

# Get zip of customers and determine which cluster theze zips belong to.
customers <- readxl::read_xlsx("combined_data.xlsx", sheet = "Customer")

i = 1
zipList <- character()
for(ID in cusList) {
  temp <- subset(customers, CusKey == cusList[i])
  zipList <- c(zipList, as.character(temp[1, "ShipZip"]))
  i = i + 1
}

getMode <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}

BestZIP <- getMode(zipList)

BestZIPCluster <- subset(R16, Clstzip == BestZIP)
BestCluster <- as.character(BestZIPCluster[1, "cluster"])

# Get zips from this cluster and get customers in those zips
similarZones <- subset(R16, cluster == BestCluster)

similarZips <- similarZones[['Clstzip']]

i = 1
similarCust <- vector()
for(zips in similarZips) {
  temp <- subset(customers, ShipZip == similarZips[i])
  similarCust <- c(similarCust, temp["CusKey"])
  i = i + 1
}

similarCust <- unlist(similarCust, recursive = FALSE)
similarCust <- unname(similarCust)
similarCust <- unique(similarCust)

newCustomers <- vector()
for (ID in similarCust) {
  temp <- subset(Customer_Product, CusKey == ID & ItemKey == itemkey)
  if (nrow(temp) == 0) {
    newCustomers <- c(newCustomers, ID)
  }
}

isFirst = TRUE
for (ID in newCustomers) {
  if (isFirst) {
    FinalList <- subset(customers, CusKey == ID)
    isFirst = FALSE
  }
  else {
    temp <- subset(customers, CusKey == ID)
    FinalList <- rbind(FinalList, temp)
  }
}
